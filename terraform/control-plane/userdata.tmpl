#!/usr/bin/env bash

set -ex

## Setting variables
AWS_DEFAULT_REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone 2>/dev/null | head -c -1)
AWS_ACCOUNT_ID=$(curl -s http://169.254.169.254/latest/meta-data/identity-credentials/ec2/info | grep AccountId | awk '{print $3}' | tr -d '"')

## updates
yum update -y
yum upgrade -y

## enabling amazon-linux-extras
amazon-linux-extras enable vim epel docker
amazon-linux-extras install vim epel docker -y
systemctl enable docker

## installing some base packages
PACKAGES="
amazon-ecr-credential-helper
atop
curl
dstat
git
htop
iftop
initscripts
iotop
jq
ncdu
net-tools
nload
python3
python3-pip
python3-setuptools
unzip
wget
"

for p in $${PACKAGES}; do
  yum install -y $${p}
done

## disabling aws controlled motd
update-motd --disable

cat << "EOF" > /etc/motd
       ___ __          __                   _
      / (_) /_  ____ _/ /____  __________  (_)
 __  / / / __ \/ __ `/ //_/ / / / ___/ _ \/ /
/ /_/ / / /_/ / /_/ / ,< / /_/ / /  /  __/ /
\____/_/_.___/\__,_/_/|_|\__,_/_/   \___/_/

* * * * * * * * * * * * * * W A R N I N G * * * * * * * * * * * * * *
This computer system is the property of Jibakurei.
It is for authorized use only.  By using this system, all users
acknowledge notice of, and agree to comply with, Jibakurei
Information Technology Resources Policy.  Unauthorized or improper
use of this system may result in administrative disciplinary action,
civil charges/criminal penalties. By continuing to use this system you
indicate your awareness of and consent to these terms and conditions
of use.

LOG OFF IMMEDIATELY if you do not agree to the conditions stated in
this warning.

* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *


EOF] 0
\[poinpubyotvcnuexwzrQCxZq## Docker Config
cat << EOF > /etc/sysconfig/docker
# The max number of open files for the daemon itself, and all
# running containers.  The default value of 1048576 mirrors the value
# used by the systemd service unit.
DAEMON_MAXFILES=1048576

# Additional startup options for the Docker daemon, for example:
# OPTIONS="--ip-forward=true --iptables=true"
# By default we limit the number of open files per container
OPTIONS='--default-ulimit nofile=1000000:1000000'

# How many seconds the sysvinit script waits for the pidfile to appear
# when starting the daemon.
DAEMON_PIDFILE_TIMEOUT=10
EOF

systemctl restart docker

## ECR Helper

mkdir -p /root/.docker
mkdir -p /home/ec2-user/.docker


cat << EOF > /root/.docker/config.json
{
	"credHelpers": {
		"$${AWS_ACCOUNT_ID}.dkr.ecr.$${AWS_DEFAULT_REGION}.amazonaws.com": "ecr-login"
	}
}
EOF

cp /root/.docker/config.json /home/ec2-user/.docker/config.json
